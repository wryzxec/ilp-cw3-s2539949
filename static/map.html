<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>ILP Drone Map</title>

  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
    }

    #map {
      width: 100%;
      height: 100%;
    }

    .glow-blue-path {
      stroke: #00bfff;
      stroke-width: 2;
      stroke-linejoin: round;
      stroke-linecap: round;
      filter: drop-shadow(0 0 4px #00bfff)
              drop-shadow(0 0 8px #00bfff);
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <script>
  const map = L.map("map").setView([55.9445, -3.1867], 14);

  L.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png", {
    maxZoom: 19,
    attribution: "&copy; OpenStreetMap contributors &copy; CARTO",
  }).addTo(map);

  let geojsonLayer = null;           // path layer
  let servicePointsLayer = null;     // new: service points layer

  async function loadPath() {
    try {
      const response = await fetch(`/static/path.geojson?ts=${Date.now()}`, {
        cache: "no-store",
      });
      console.log("Fetch /static/path.geojson status:", response.status);

      if (!response.ok) {
        console.warn("No path.geojson yet or failed to fetch:", response.status);
        return;
      }

      const data = await response.json();
      console.log("GeoJSON data:", data);

      if (geojsonLayer) {
        map.removeLayer(geojsonLayer);
      }

      geojsonLayer = L.geoJSON(data, {
        style: function (feature) {
          if (feature.geometry.type === "LineString") {
            return {
              color: "#00bfff",
              weight: 4,
              opacity: 1.0,
              className: "glow-blue-path",
            };
          }
          return {};
        },

        pointToLayer: function (feature, latlng) {
          const props = feature.properties || {};
          if (props.kind === "stop") {
            const idx = props.index ?? 0;
            let color = "#ff0000";

            return L.circleMarker(latlng, {
              radius: 5,
              color: color,
              fillColor: color,
              fillOpacity: 1.0,
            });
          }
        },
      }).addTo(map);

      // auto adjust map to path bounds
      const bounds = geojsonLayer.getBounds();
      if (bounds.isValid()) {
        map.fitBounds(bounds, { padding: [20, 20], maxZoom: 14 });
      }
    } catch (err) {
      console.error("Error loading path.geojson:", err);
    }
  }

  async function loadServicePoints() {
    try {
      const response = await fetch(`/static/service_points.geojson?ts=${Date.now()}`, {
        cache: "no-store",
      });
      console.log("Fetch /static/service_points.geojson status:", response.status);

      if (!response.ok) {
        console.warn("No service_points.geojson yet or failed to fetch:", response.status);
        return;
      }

      const data = await response.json();
      console.log("Service points GeoJSON:", data);

      if (servicePointsLayer) {
        map.removeLayer(servicePointsLayer);
      }

      servicePointsLayer = L.geoJSON(data, {
        pointToLayer: function (feature, latlng) {
          const props = feature.properties || {};
          const name = props.name || `Service Point ${props.id ?? ""}`;

          return L.circleMarker(latlng, {
            radius: 10,
            color: "#cccccc",
            fillColor: "#cccccc",
            fillOpacity: 1.0,
          }).bindPopup(name);
        },
      }).addTo(map);
    } catch (err) {
      console.error("Error loading service_points.geojson:", err);
    }
  }

  loadPath();
  loadServicePoints();

  setInterval(loadPath, 5000);
  setInterval(loadServicePoints, 5000)
</script>

</body>
</html>